name: Pages API Deploy Test

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-20:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Node version
        run: |
          node -v && npm -v

      - name: Install dependencies
        working-directory: collapse_web_new
        run: npm ci
      - name: Rebuild native modules (diagnostic)
        working-directory: collapse_web_new
        run: npm rebuild || true

      - name: Node & Rollup version (light)
        working-directory: collapse_web_new
        run: |
          node -v && npm -v
          node -e "try { console.log('rollup', require('rollup/package.json').version) } catch (e) { console.error('rollup not found') }" || true

      # Removed explicit rollup native install; rely on npm install and npm rebuild steps during CI.

      - name: Build site
        working-directory: collapse_web_new
        run: npm run build

      - name: Upload pages artifact (Pages API format)
        uses: actions/upload-pages-artifact@v3
        with:
          name: pages-node-20
          path: collapse_web_new/docs

  build-18:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        working-directory: collapse_web_new
        run: npm ci
      - name: Rebuild native modules (diagnostic)
        working-directory: collapse_web_new
        run: npm rebuild || true

      - name: Check Rollup bindings (diagnostic)
        working-directory: collapse_web_new
        run: |
          node -v && npm -v
          echo "rollup/package.json:"
          node -e "try { console.log(require('rollup/package.json').version) } catch (e) { console.error('rollup not found', e.message); process.exit(0) }"
          echo "@rollup dir listing:"
          ls -la node_modules/@rollup || true
          echo "Installed optional rollup packages:"
          ls -la node_modules/@rollup | grep rollup- || true
          echo "File exists check for linux x64 gnu binding:"
          node -e "console.log(require('fs').existsSync(require('path').resolve('node_modules/@rollup/rollup-linux-x64-gnu')))" || true

      - name: Ensure rollup native (Linux x64) if missing
        if: runner.os == 'Linux'
        working-directory: collapse_web_new
        run: |
          set -euxo pipefail
          ROLLUP_VER=$(node -p "require('rollup/package.json').version")
          echo "Detected rollup version: $ROLLUP_VER"
          echo "Installing optional rollup native package for linux-x64-gnu"
          npm i --no-save @rollup/rollup-linux-x64-gnu@$ROLLUP_VER
          echo "After installing optional package, list @rollup packages:"
          ls -la node_modules/@rollup || true

      - name: Build site
        working-directory: collapse_web_new
        run: npm run build

      - name: Upload pages artifact (Pages API format)
        uses: actions/upload-pages-artifact@v3
        with:
          name: pages-node-18
          path: collapse_web_new/docs

  deploy:
    runs-on: ubuntu-latest
    needs: build-18
    environment:
      name: github-pages
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download pages artifact (from Node 18 build)
        uses: actions/download-artifact@v4
        with:
          name: pages-node-18
          path: pages

      - name: Deploy to GitHub Pages (via Pages API)
        uses: actions/deploy-pages@v4
        with:
          artifact_name: pages-node-18
