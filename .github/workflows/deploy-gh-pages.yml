name: Build and Deploy (gh-pages)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write



jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      docs-path: ${{ steps.set-docs-path.outputs.docs-path }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: collapse_web_new/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('collapse_web_new/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Node & npm version
        run: |
          node -v && npm -v
        working-directory: collapse_web_new

      - name: Install dependencies (collapse_web_new)
        env:
          # Prevent Playwright from automatically downloading browser binaries during npm install
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
        run: |
          set -euxo pipefail
          echo "Installing dependencies in collapse_web_new (verbose)"
          echo "Node: $(node -v)" && echo "NPM: $(npm -v)"
          # Show .npmrc if present so we can debug auth/registry config issues
          echo "--- collapse_web_new/.npmrc (if present) ---"
          cat collapse_web_new/.npmrc || true
          # Run install without silent to ensure logs are captured in Actions output
          npm ci --no-audit --loglevel=verbose
          echo "Installed packages; node modules count:"
          ls -la collapse_web_new/node_modules | wc -l || true
        working-directory: collapse_web_new

      - name: Ensure Rollup native binary (linux x64)
        if: runner.os == 'Linux'
        run: |
          set -euxo pipefail
          npm install --no-save @rollup/rollup-linux-x64-gnu
        working-directory: collapse_web_new

      # removed verbose Rollup diagnostics; kept minimal node/npm version above

      # removed explicit rollup native install; rely on npm install and npm rebuild

      - name: Run tests (collapse_web_new)
        run: npm test -- --run
        working-directory: collapse_web_new
        continue-on-error: true

      - name: Build (collapse_web_new)
        run: |
          set -euxo pipefail
          echo "Checking package.json scripts:"
          cat package.json | jq -r '.scripts'
          echo "Starting build"
          npm run build --if-present
        working-directory: collapse_web_new
        continue-on-error: true

      - name: Check build output (docs)
        run: |
          echo "Collapse web build dir listing:"
          ls -la docs || true
          echo "--- index.html head ---"
          head -n 30 docs/index.html || true
          echo "--- assets listing ---"
          ls -la docs/assets || true
        working-directory: collapse_web_new


      # removed debug artifact upload to clean up CI logs (keep pages artifacts)

      - name: Upload pages artifact (Pages API format)
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: collapse_web_new/docs

      - name: Set docs path output
        id: set-docs-path
        run: |
          echo "docs-path=collapse_web_new/docs" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy_pages_api.outputs.page_url }}
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    outputs:
      page_url: ${{ steps.deploy_pages_api.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download pages artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: pages

      - name: "Debug: show pages folder"
        run: |
          echo "Listing pages folder:" && ls -la pages || true

      - name: "Debug: show env and pages listing"
        run: |
          echo "__GITHUB_REPOSITORY__=$GITHUB_REPOSITORY"
          echo "__GITHUB_ACTOR__=$GITHUB_ACTOR"
          echo "__GITHUB_REPOSITORY_OWNER__=$GITHUB_REPOSITORY_OWNER"
          echo "Listing pages folder to confirm artifact contents:" && ls -la pages || true

      - name: "Debug: Show pages index and size"
        run: |
          echo "pages dir size:" && du -sh pages || true
          echo "pages index head (first 30 lines):" && head -n 30 pages/index.html || true

      - name: "Debug: Confirm Pages configuration"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Pages API config for repository: $GITHUB_REPOSITORY"
          curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github.v3+json" "https://api.github.com/repos/$GITHUB_REPOSITORY/pages" || true

      - name: Deploy to GitHub Pages (via Pages API)
        id: deploy_pages_api
        uses: actions/deploy-pages@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          artifact_name: github-pages

      - name: Output Pages URL
        run: |
          echo "Deployed site URL: ${{ steps.deploy_pages_api.outputs.page_url }}"

      # Pages API is the primary deploy method. The explicit `peaceiris` fallback was removed
      # after successful validation runs. If you need a branch-based fallback later, re-add
      # a fallback step similar to the previous implementation.

  deploy_fallback:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: needs.deploy.result != 'success'
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download pages artifact
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: pages

      - name: "Fallback: Publish to gh-pages branch (peaceiris)"
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./pages
